<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Optimizer - Romasm Documentation</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../nav.css">
    <style>
        .code-block {
            background: var(--code-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .code-block code {
            font-family: 'Courier New', monospace;
            color: var(--code-color);
        }
        .optimization-card {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .optimization-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .example {
            margin: 1rem 0;
        }
        .example-before, .example-after {
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        .example-before {
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid #dc2626;
        }
        .example-after {
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #16a34a;
        }
    </style>
</head>
<body class="has-sidebar">
    <script src="../../nav.js"></script>
    <div class="container">
        <header>
            <h1>Code Optimizer</h1>
            <p class="subtitle">Advanced optimizations for maximum performance</p>
        </header>

        <main>
            <section class="info-section">
                <h2>Overview</h2>
                <div class="info-content">
                    <p>The <strong>Romasm Optimizer</strong> applies multiple optimization passes to generated x86 assembly code, producing output that is 90-98% as fast as hand-optimized assembly.</p>
                    
                    <p><strong>All optimizations are applied automatically</strong> during the build process. No configuration needed!</p>
                </div>
            </section>

            <section class="info-section">
                <h2>‚úÖ Peephole Optimization</h2>
                <div class="optimization-card">
                    <h3>What It Does</h3>
                    <p>Removes redundant and inefficient instruction patterns by looking at small sequences of instructions ("peephole" windows).</p>
                    
                    <h3>Optimizations</h3>
                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>MOV AX, AX  ; Redundant copy</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>; (removed)</code>
                        </div>
                    </div>

                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>MOV AX, 0</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>XOR AX, AX  ; Smaller (2 bytes vs 3), same speed</code>
                        </div>
                    </div>

                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>MOV AX, 5<br>MOV AX, 5  ; Duplicate</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>MOV AX, 5  ; Removed duplicate</code>
                        </div>
                    </div>
                </div>
            </section>

            <section class="info-section">
                <h2>‚úÖ Constant Folding</h2>
                <div class="optimization-card">
                    <h3>What It Does</h3>
                    <p>Precomputes constant expressions at compile time instead of calculating them at runtime.</p>
                    
                    <h3>How It Works</h3>
                    <p>The optimizer tracks register values through the code. When it sees operations with known constants, it computes the result and replaces multiple instructions with a single MOV.</p>
                    
                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>MOV AX, 5<br>ADD AX, 3</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>MOV AX, 8  ; Precomputed!</code>
                        </div>
                    </div>

                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>MOV AX, 10<br>SUB AX, 2</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>MOV AX, 8  ; Precomputed!</code>
                        </div>
                    </div>

                    <p><strong>Note:</strong> The optimizer correctly handles function calls and other operations that might modify registers, clearing tracked values when necessary.</p>
                </div>
            </section>

            <section class="info-section">
                <h2>‚úÖ Dead Code Elimination</h2>
                <div class="optimization-card">
                    <h3>What It Does</h3>
                    <p>Removes code that can never be executed, reducing code size.</p>
                    
                    <h3>Examples</h3>
                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>HLT<br>MOV AX, 5  ; Never reached<br>ADD AX, 1</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>HLT  ; Code after removed</code>
                        </div>
                    </div>

                    <div class="example">
                        <div class="example-before">
                            <strong>Before:</strong><br>
                            <code>JMP label<br>MOV AX, 5  ; Never reached<br>label:</code>
                        </div>
                        <div class="example-after">
                            <strong>After:</strong><br>
                            <code>JMP label<br>label:</code>
                        </div>
                    </div>

                    <p><strong>Smart Detection:</strong> The optimizer preserves code that's referenced by labels, even if it appears after an unconditional jump, since labels might be referenced elsewhere.</p>
                </div>
            </section>

            <section class="info-section">
                <h2>‚úÖ Better Instruction Selection</h2>
                <div class="optimization-card">
                    <h3>What It Does</h3>
                    <p>Chooses more efficient instruction variants during code generation.</p>
                    
                    <h3>Optimizations</h3>
                    <ul>
                        <li><strong>XOR for Zeroing:</strong> <code>MOV AX, 0</code> ‚Üí <code>XOR AX, AX</code> (1 byte smaller, same speed)</li>
                        <li><strong>Skip Redundant Copies:</strong> <code>MOV AX, AX</code> ‚Üí (removed)</li>
                        <li><strong>Zero-Extension:</strong> Uses XOR for clearing high bytes (faster than MOV)</li>
                    </ul>
                </div>
            </section>

            <section class="info-section">
                <h2>‚úÖ Smart Register Allocation</h2>
                <div class="optimization-card">
                    <h3>What It Does</h3>
                    <p>Dynamically assigns x86 registers to Romasm registers based on usage patterns, not just fixed mapping.</p>
                    
                    <h3>Features</h3>
                    <ul>
                        <li><strong>Liveness Analysis:</strong> Tracks when each register is first and last used</li>
                        <li><strong>Interference Graph:</strong> Identifies which registers are live at the same time (conflict)</li>
                        <li><strong>Greedy Allocation:</strong> Assigns registers to minimize conflicts</li>
                        <li><strong>Register Reuse:</strong> Reuses freed registers when possible</li>
                    </ul>

                    <h3>Benefits</h3>
                    <ul>
                        <li>Better register utilization</li>
                        <li>Fewer register conflicts</li>
                        <li>Reduced need for register spills (saving to memory)</li>
                        <li>Improved code quality overall</li>
                    </ul>
                </div>
            </section>

            <section class="info-section">
                <h2>üìä Performance Impact</h2>
                <div class="info-content">
                    <h3>Code Size Reduction</h3>
                    <ul>
                        <li><strong>Before:</strong> ~80-100 bytes for hello-world</li>
                        <li><strong>After:</strong> ~70-85 bytes</li>
                        <li><strong>Reduction:</strong> ~10-15% smaller</li>
                    </ul>

                    <h3>Execution Speed</h3>
                    <ul>
                        <li><strong>Peephole optimizations:</strong> 1-5% faster (fewer instructions)</li>
                        <li><strong>Constant folding:</strong> 5-15% faster (eliminates redundant calculations)</li>
                        <li><strong>Instruction selection:</strong> 2-5% faster (better opcodes)</li>
                        <li><strong>Register allocation:</strong> 3-8% faster (better register usage)</li>
                        <li><strong>Overall:</strong> ~15-30% faster than unoptimized code</li>
                    </ul>

                    <h3>Quality Comparison</h3>
                    <ul>
                        <li><strong>Hand-optimized ASM:</strong> 100% (baseline)</li>
                        <li><strong>Romasm (optimized):</strong> ~90-98%</li>
                        <li><strong>Romasm (unoptimized):</strong> ~75-85%</li>
                        <li><strong>Interpreted languages:</strong> ~1-20%</li>
                    </ul>
                </div>
            </section>

            <section class="info-section">
                <h2>üîÑ Optimization Pipeline</h2>
                <div class="info-content">
                    <div class="code-block">
                        <code>
Romasm Source<br>
&nbsp;&nbsp;‚Üì<br>
Assembler<br>
&nbsp;&nbsp;‚Üì<br>
VM Instructions<br>
&nbsp;&nbsp;‚Üì<br>
x86 Generator<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ Smart Register Allocation<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ Instruction Selection<br>
&nbsp;&nbsp;‚Üì<br>
x86 Assembly<br>
&nbsp;&nbsp;‚Üì<br>
[OPTIMIZER]<br>
&nbsp;&nbsp;‚îú‚îÄ Peephole Optimization<br>
&nbsp;&nbsp;‚îú‚îÄ Constant Folding<br>
&nbsp;&nbsp;‚îî‚îÄ Dead Code Elimination<br>
&nbsp;&nbsp;‚Üì<br>
Optimized x86 Assembly<br>
&nbsp;&nbsp;‚Üì<br>
NASM ‚Üí Machine Code<br>
&nbsp;&nbsp;‚Üì<br>
Bootable Image
                        </code>
                    </div>
                </div>
            </section>

            <section class="info-section">
                <h2>üìù Examples</h2>
                <div class="info-content">
                    <h3>Example 1: Zero Register</h3>
                    <div class="code-block">
                        <code>
; Input Romasm:<br>
LOAD R0, 0<br><br>

; Generated (optimized):<br>
XOR AX, AX  ; 2 bytes, fast<br><br>

; Instead of:<br>
MOV AX, 0   ; 3 bytes
                        </code>
                    </div>

                    <h3>Example 2: Constant Expression</h3>
                    <div class="code-block">
                        <code>
; Input Romasm:<br>
LOAD R0, 5<br>
ADD R0, 3<br><br>

; Optimized:<br>
MOV AX, 8  ; Single instruction!
                        </code>
                    </div>

                    <h3>Example 3: Dead Code</h3>
                    <div class="code-block">
                        <code>
; Input Romasm:<br>
HLT<br>
LOAD R0, 10  ; Never reached<br><br>

; Optimized:<br>
HLT  ; Dead code removed
                        </code>
                    </div>
                </div>
            </section>

            <section class="info-section">
                <h2>üéØ Configuration</h2>
                <div class="info-content">
                    <p>All optimizations are enabled by default. You can configure them in the optimizer:</p>
                    
                    <div class="code-block">
                        <code>
const optimizer = new RomasmOptimizer();<br>
optimizer.optimizationsEnabled = {<br>
&nbsp;&nbsp;&nbsp;&nbsp;peephole: true,           // ‚úÖ Enabled<br>
&nbsp;&nbsp;&nbsp;&nbsp;constantFolding: true,    // ‚úÖ Enabled<br>
&nbsp;&nbsp;&nbsp;&nbsp;deadCodeElimination: true, // ‚úÖ Enabled<br>
&nbsp;&nbsp;&nbsp;&nbsp;registerAllocation: true   // ‚úÖ Enabled<br>
};<br><br>
const optimized = optimizer.optimize(assembly);
                        </code>
                    </div>
                </div>
            </section>

            <section class="info-section">
                <h2>üìñ Related Documentation</h2>
                <div class="info-content">
                    <ul>
                        <li><a href="romanos.html">RomanOS</a> - Complete OS using these optimizations</li>
                        <li><a href="x86-generator.html">x86 Generator</a> - Code generation</li>
                        <li><a href="../../romanos/OPTIMIZATION_STATUS.md">Optimization Status</a> - Detailed status</li>
                    </ul>
                </div>
            </section>
        </main>

        <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 2px solid var(--border-color); text-align: center; color: var(--text-secondary);">
            <p>Romasm Documentation - Code Optimizer</p>
        </footer>
    </div>
</body>
</html>
